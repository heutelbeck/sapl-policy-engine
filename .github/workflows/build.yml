#
# Copyright Â© 2017-2024 Dominic Heutelbeck (dominic@heutelbeck.com)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: Testing and Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
    tags:
      - 'v*'
    paths-ignore:
      - 'sapl-documentation/**'
      - '.github/workflows/**'
      - '!.github/workflows/build.yml'
      - '**.md'
  pull_request:
    paths-ignore:
      - 'sapl-documentation/**'
      - '.github/workflows/**'
      - '!.github/workflows/build.yml'
      - '**.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: '22'

jobs:

  # ---------------------------------------------------------------------------
  # Phase 1: Build and Test (parallel)
  # ---------------------------------------------------------------------------

  version-check:
    name: Check Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is_snapshot: ${{ steps.get-version.outputs.is_snapshot }}
      is_tag: ${{ steps.check-ref.outputs.is_tag }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Check out
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Set up JDK 25
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Extract Version
        id: get-version
        run: |
          VERSION=$( mvn help:evaluate -Dexpression=project.version -q -DforceStdout )
          if [ -z "$VERSION" ]; then
            echo "ERROR: Failed to extract version"
            exit 1
          fi
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [[ "$VERSION" == *-SNAPSHOT ]]; then
            echo "is_snapshot=true" >> $GITHUB_OUTPUT
          else
            echo "is_snapshot=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Ref Type
        id: check-ref
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Clean up Local Repository before Caching
        run: rm -rf ~/.m2/repository/io/sapl

  test:
    strategy:
      matrix:
        java: [ '21', '25' ]
        os: [ubuntu-latest, windows-latest]
      fail-fast: false
    name: Test (JDK ${{ matrix.java }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    permissions:
      checks:  write
    timeout-minutes: 60

    env:
      RUN_ANALYSIS: ${{ (matrix.os == 'ubuntu-latest') && (matrix.java == '25') }}
      IS_FORK: ${{ github.event.pull_request.head.repo.fork || (github.actor == 'dependabot[bot]') }}

    steps:
      - name: Harden Runner
        if: matrix.os == 'ubuntu-latest'
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Check out
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: ${{ (env.IS_FORK == 'true') && 50 || 0 }}

      - name: Dependency Review
        if: ${{ (env.RUN_ANALYSIS == 'true') && (github.event_name == 'pull_request') }}
        uses: actions/dependency-review-action@4901385134134e04cec5fbe5ddfe3b2c5bd5d976 # v4.0.0

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java }}
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build Dependencies of SAPL Node
        if: env.RUN_ANALYSIS == 'true'
        run: mvn -U -B install -pl sapl-node -am -DskipTests

      - name: Build SAPL Node Image
        if: env.RUN_ANALYSIS == 'true'
        run: mvn -B spring-boot:build-image -pl sapl-node -DskipTests

      - name: Run Unit Tests Only
        if: env.RUN_ANALYSIS == 'false'
        run: mvn -B package javadoc:jar

        # Runs JaCoCo and Spotbugs analysis which are needed for the subsequent
        # SonarCloud analysis. The SonarCloud analysis is run separately because a
        # distinction has to be made between workflows triggered by pull requests from a
        # fork and workflows triggered by other events.
      - name: Run Unit Tests, Analysis, and Integration Tests
        if: env.RUN_ANALYSIS == 'true'
        run: mvn -B verify javadoc:jar spotbugs:spotbugs -pl '!sapl-bom,!sapl-code-style' -Pcoverage,it,spotbugs -T 1.5C

      - name: Cache Sonar Packages
        if: ${{ (env.RUN_ANALYSIS == 'true') && (env.IS_FORK == 'false') }}
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

        # For the SonarCloud analysis to contain rules and issues from SpotBugs, the
        # SpotBugs report path needs to be added as a parameter. Coverage information
        # from JaCoCo is included automatically as long as the report is found at its
        # usual place in target/site/jacoco/jacoco.xml.
        # The analysis will fail if the quality gate defined on SonarCloud fails
        # (sonar.qualitygate.wait=true).
      - name: Run SonarCloud Analysis
        if: ${{ (env.RUN_ANALYSIS == 'true') && (env.IS_FORK == 'false') }}
        env:
          SONAR_TOKEN: ${{ secrets.SONARCLOUD_TOKEN }}
        run: >
          mvn -B sonar:sonar
          -pl '!sapl-bom,!sapl-code-style'
          -Dsonar.organization=heutelbeck
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.projectKey=heutelbeck_sapl-policy-engine
          -Dsonar.java.spotbugs.reportPaths=target/spotbugsXml.xml
          -Dsonar.qualitygate.wait=true
          -Pproduction

        # The two following steps "Save PR Number" and "Upload Artifact" are needed for a
        # SonarCloud analysis for pull requests from forks. Workflows triggered by pull
        # requests from forks cannot access repository secrets. And a SonarCloud analysis
        # cannot be run without a secret SonarCloud token. The information and files
        # needed for a SonarCloud analysis are thus uploaded as an artifact and used in a
        # subsequent SonarCloud analysis workflow triggered by the conclusion of the
        # current workflow.
      - name: Save PR Number
        if: ${{ (env.RUN_ANALYSIS == 'true') && (env.IS_FORK == 'true') }}
        run: echo "${{ github.event.number }}" > pr_data.txt

        # See comment on previous step "Save PR Number".
        # An artifact is uploaded for a subsequent SonarCloud analysis. For its standard
        # analysis of Maven projects, SonarCloud needs the pom.xml, the java classes, the
        # compiled classes as well as the scm information (.git).
        # To include coverage information and spotbugs issues in the analysis, the
        # respective reports are needed.
        # To limit its analysis to the pull request that triggered this workflow, the pull
        # request's number is needed.
      - name: Upload Artifact
        if: ${{ (env.RUN_ANALYSIS == 'true') && (env.IS_FORK == 'true') }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: pr_build
          path: |
            pom.xml
            **/pom.xml
            **/src
            **/target/classes
            **/target/test-classes
            .git
            !.git/config
            !.git/credentials
            !.git/**/config
            **/target/site/jacoco/jacoco.xml
            **/target/spotbugsXml.xml
            pr_data.txt
            **/META-INF
            **/*.target
            **/category.xml
            **/feature.xml
            **/plugin.xml
          retention-days: 1

        # This action currently contains a bug. If a commit triggers more than one workflow
        # run all test reports are published on the first workflow run.
        # See: https://github.com/ScaCap/action-surefire-report/issues/75
      - name: Publish Test Report
        if: ${{ (success() || failure()) && (env.RUN_ANALYSIS == 'true') && (env.IS_FORK == 'false') }}
        uses: scacap/action-surefire-report@a2911bd1a4412ec18dde2d93b1758b3e56d2a880 # v1.8.0

      - name: Clean up Local Repository before Caching
        shell: bash
        run: rm -rf ~/.m2/repository/io/sapl

  build-docker:
    if: ${{ github.event_name != 'pull_request' }}
    needs: [version-check]
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    timeout-minutes: 60

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Check out
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          lfs: true
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
          server-id: central
          server-username: NEXUS_USERNAME
          server-password: NEXUS_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Configure Servers
        uses: s4u/maven-settings-action@7802f6aec16c9098b4798ad1f1d8ac75198194bd # v3.0.0
        with:
          githubServer: false
          servers: |
            [{
              "id": "central",
              "username": "${{ secrets.NEXUS_USERNAME }}",
              "password": "${{ secrets.NEXUS_PASSWORD }}"
            }, {
              "id": "github",
              "username": "${{ secrets.GHUB_USERNAME }}",
              "password": "${{ secrets.GHUB_ACCESS_TOKEN }}"
            }]

      - name: Install GPG Code Signing Key
        run: |
          cat <(echo -e "${{ secrets.GPG_PRIVATE_KEY }}") | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build All for Server
        run: mvn -U -B clean install -DskipTests -Psign,production -T 1.5C
        env:
          MAVEN_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.NEXUS_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Build SAPL Node Image
        run: mvn -B spring-boot:build-image -pl sapl-node -DskipTests

      - name: Build SAPL Playground Image
        run: mvn -B spring-boot:build-image -pl sapl-playground -DskipTests -Pproduction

      - name: Save SAPL Node Image
        run: docker save ghcr.io/heutelbeck/sapl-node:${{ needs.version-check.outputs.version }} | gzip > sapl-node-docker-image.tar.gz

      - name: Save SAPL Playground Image
        run: docker save ghcr.io/heutelbeck/sapl-playground:${{ needs.version-check.outputs.version }} | gzip > sapl-playground-docker-image.tar.gz

      - name: Upload Docker Image Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: docker-images
          path: |
            sapl-node-docker-image.tar.gz
            sapl-playground-docker-image.tar.gz
          if-no-files-found: error
          retention-days: 1

      - name: Upload SAPL Node JAR Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sapl-node-jars
          if-no-files-found: error
          path: |
            sapl-node/target/sapl-node-*.jar
            sapl-node/target/sapl-node-*.jar.asc
            sapl-node/target/sapl-node-*.jar.sha1
            sapl-node/target/sapl-node-*.jar.md5
            sapl-node/target/site/io.*.spdx.json
          retention-days: 1

      - name: Clean up Local Repository before Caching
        run: rm -rf ~/.m2/repository/io/sapl

  build-native-node:
    if: ${{ github.event_name != 'pull_request' }}
    uses: ./.github/workflows/build_native_node.yml
    secrets: inherit

  build-native-lsp:
    if: ${{ github.event_name != 'pull_request' }}
    uses: ./.github/workflows/build_native_lsp.yml
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Phase 2: Publish (gated on all of Phase 1)
  # ---------------------------------------------------------------------------

  publish-maven:
    needs: [test, version-check, build-native-node, build-native-lsp, build-docker]
    if: >-
      ${{
        !failure() && !cancelled() &&
        (
          (github.ref == 'refs/heads/master' && needs.version-check.outputs.is_snapshot == 'true')
          || needs.version-check.outputs.is_tag == 'true'
        )
      }}
    name: Publish Maven Artifacts
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 60

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Check out
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          lfs: true
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'
          server-id: central
          server-username: NEXUS_USERNAME
          server-password: NEXUS_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Configure Servers
        uses: s4u/maven-settings-action@7802f6aec16c9098b4798ad1f1d8ac75198194bd # v3.0.0
        with:
          githubServer: false
          servers: |
            [{
              "id": "central",
              "username": "${{ secrets.NEXUS_USERNAME }}",
              "password": "${{ secrets.NEXUS_PASSWORD }}"
            }, {
              "id": "github",
              "username": "${{ secrets.GHUB_USERNAME }}",
              "password": "${{ secrets.GHUB_ACCESS_TOKEN }}"
            }]

      - name: Install GPG Code Signing Key
        run: |
          cat <(echo -e "${{ secrets.GPG_PRIVATE_KEY }}") | gpg --batch --import
          gpg --list-secret-keys --keyid-format LONG

      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Deploy Maven Artifacts
        run: mvn -B --no-transfer-progress -pl !:sapl-node,!:sapl-playground,!:sapl-documentation-generator -PsonatypeDeploy -DskipTests clean deploy
        env:
          MAVEN_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.NEXUS_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Clean up Local Repository before Caching
        run: rm -rf ~/.m2/repository/io/sapl

  publish-docker:
    needs: [test, version-check, build-native-node, build-native-lsp, build-docker]
    if: >-
      ${{
        !failure() && !cancelled() &&
        (
          (github.ref == 'refs/heads/master' && needs.version-check.outputs.is_snapshot == 'true')
          || needs.version-check.outputs.is_tag == 'true'
        )
      }}
    name: Publish Docker Images
    runs-on: ubuntu-latest
    outputs:
      sapl-node-hashes: ${{ steps.get-server-lt-hash.outputs.hashes }}
      sapl-node-docker-digest: ${{ steps.get-server-lt-hash.outputs.IMAGE_DIGEST }}
      sapl-playground-docker-digest: ${{ steps.get-playground-hash.outputs.IMAGE_DIGEST }}
    permissions:
      contents: read
      packages: write
    timeout-minutes: 30

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Download Docker Image Artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: docker-images

      - name: Download SAPL Node JAR Artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sapl-node-jars
          path: sapl-node/target

      - name: Load SAPL Node Image
        run: docker load < sapl-node-docker-image.tar.gz

      - name: Load SAPL Playground Image
        run: docker load < sapl-playground-docker-image.tar.gz

      - name: Log in to the Container Registry
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHUB_ACCESS_TOKEN }}

      - name: Push SAPL Node Image to ghcr.io
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: docker push ghcr.io/heutelbeck/sapl-node:${{ needs.version-check.outputs.version }}

      - name: Push Playground Image to ghcr.io
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: docker push ghcr.io/heutelbeck/sapl-playground:${{ needs.version-check.outputs.version }}

      - name: Get hashes of SAPL Node
        id: get-server-lt-hash
        env:
          REGISTRY: ghcr.io
          IMAGE: heutelbeck/sapl-node:${{ needs.version-check.outputs.version }}
        run: |
          # Save the location of the maven output files for easier reference
          ARTIFACT_PATTERN=sapl-node/target/sapl-node-*.jar

          echo "hashes=$(sha256sum $ARTIFACT_PATTERN | base64 -w0)" >> "$GITHUB_OUTPUT"

          # Save the digest of the Docker image for later use
          IMAGE_DIGEST=$(docker inspect ${REGISTRY}/${IMAGE} --format '{{index .RepoDigests 0}}' | cut -d'@' -f2)
          echo "Digest of container: $IMAGE_DIGEST"
          echo "IMAGE_DIGEST=$IMAGE_DIGEST" >> $GITHUB_OUTPUT

      - name: Get hash of Playground
        id: get-playground-hash
        env:
          REGISTRY: ghcr.io
          IMAGE: heutelbeck/sapl-playground:${{ needs.version-check.outputs.version }}
        run: |
          # Save the digest of the Docker image for later use
          IMAGE_DIGEST=$(docker inspect ${REGISTRY}/${IMAGE} --format '{{index .RepoDigests 0}}' | cut -d'@' -f2)
          echo "Digest of container: $IMAGE_DIGEST"
          echo "IMAGE_DIGEST=$IMAGE_DIGEST" >> $GITHUB_OUTPUT

  publish-native-node:
    needs: [test, version-check, build-native-node, build-native-lsp, build-docker]
    if: >-
      ${{
        !failure() && !cancelled() &&
        (
          (github.ref == 'refs/heads/master' && needs.version-check.outputs.is_snapshot == 'true')
          || needs.version-check.outputs.is_tag == 'true'
        )
      }}
    name: Publish Native SAPL Node
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 15

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Download Linux artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sapl-node-linux-amd64
          path: artifacts/linux

      - name: Download Windows artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sapl-node-windows-amd64
          path: artifacts/windows

      - name: Download macOS artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sapl-node-macos-arm64
          path: artifacts/macos

      - name: Prepare release assets
        run: |
          mkdir -p release
          cp artifacts/linux/sapl-node release/sapl-node-linux-amd64
          cp artifacts/windows/sapl-node.exe release/sapl-node-windows-amd64.exe
          cp artifacts/macos/sapl-node release/sapl-node-macos-arm64
          chmod +x release/sapl-node-linux-amd64
          chmod +x release/sapl-node-macos-arm64

      - name: Generate checksums
        run: |
          cd release
          sha256sum ./* > SHA256SUMS.txt

      - name: Update snapshot release
        if: ${{ needs.version-check.outputs.is_snapshot == 'true' }}
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: snapshot-node
          name: Latest SAPL Node Snapshot
          prerelease: true
          body: |
            ## Latest SAPL Node Development Snapshot

            This is an automatically updated pre-release containing the latest native builds from the `master` branch.

            **Warning:** This is a development snapshot and may be unstable.

            ### Downloads
            - `sapl-node-linux-amd64` - Linux x86_64 (static musl, works on any distro including NixOS)
            - `sapl-node-windows-amd64.exe` - Windows x86_64
            - `sapl-node-macos-arm64` - macOS Apple Silicon (ARM64)

            ### Verification
            Verify downloads using `SHA256SUMS.txt`:
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            ### Usage
            ```bash
            # Make executable (Linux/macOS)
            chmod +x sapl-node-*

            # Run with default settings
            ./sapl-node-linux-amd64

            # Run with custom config
            ./sapl-node-linux-amd64 --spring.config.location=file:./application.yml
            ```

            Built from commit: ${{ github.sha }}
          files: release/*
          fail_on_unmatched_files: true

      - name: Create release
        if: ${{ needs.version-check.outputs.is_tag == 'true' }}
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          name: SAPL Node ${{ github.ref_name }}
          body: |
            ## SAPL Node ${{ github.ref_name }}

            Native executables for the SAPL PDP Node server.

            ### Downloads
            - `sapl-node-linux-amd64` - Linux x86_64 (static musl, works on any distro including NixOS)
            - `sapl-node-windows-amd64.exe` - Windows x86_64
            - `sapl-node-macos-arm64` - macOS Apple Silicon (ARM64)

            ### Verification
            Verify downloads using `SHA256SUMS.txt`:
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            ### Usage
            ```bash
            # Make executable (Linux/macOS)
            chmod +x sapl-node-*

            # Run with default settings
            ./sapl-node-linux-amd64

            # Run with custom config
            ./sapl-node-linux-amd64 --spring.config.location=file:./application.yml

            # Generate API key
            ./sapl-node-linux-amd64 generate apikey
            ```

            ### Docker Alternative
            For containerized deployments, use the Docker image:
            ```bash
            docker pull ghcr.io/heutelbeck/sapl-node:${{ github.ref_name }}
            ```
          files: release/*
          fail_on_unmatched_files: true

  publish-native-lsp:
    needs: [test, version-check, build-native-node, build-native-lsp, build-docker]
    if: >-
      ${{
        !failure() && !cancelled() &&
        (
          (github.ref == 'refs/heads/master' && needs.version-check.outputs.is_snapshot == 'true')
          || needs.version-check.outputs.is_tag == 'true'
        )
      }}
    name: Publish Native Language Server
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 15

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Download Linux artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sapl-language-server-linux-amd64
          path: artifacts/linux

      - name: Download Windows artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sapl-language-server-windows-amd64
          path: artifacts/windows

      - name: Download macOS artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sapl-language-server-macos-arm64
          path: artifacts/macos

      - name: Prepare release assets
        run: |
          mkdir -p release
          cp artifacts/linux/sapl-language-server release/sapl-language-server-linux-amd64
          cp artifacts/windows/sapl-language-server.exe release/sapl-language-server-windows-amd64.exe
          cp artifacts/macos/sapl-language-server release/sapl-language-server-macos-arm64
          chmod +x release/sapl-language-server-linux-amd64
          chmod +x release/sapl-language-server-macos-arm64

      - name: Generate checksums
        run: |
          cd release
          sha256sum ./* > SHA256SUMS.txt

      - name: Update snapshot release
        if: ${{ needs.version-check.outputs.is_snapshot == 'true' }}
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: snapshot
          name: Latest Snapshot
          prerelease: true
          body: |
            ## Latest Development Snapshot

            This is an automatically updated pre-release containing the latest native builds from the `master` branch.

            **Warning:** This is a development snapshot and may be unstable.

            ### Downloads
            - `sapl-language-server-linux-amd64` - Linux x86_64 (static musl, works on any distro including NixOS)
            - `sapl-language-server-windows-amd64.exe` - Windows x86_64
            - `sapl-language-server-macos-arm64` - macOS Apple Silicon (ARM64)

            ### Verification
            Verify downloads using `SHA256SUMS.txt`:
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            Built from commit: ${{ github.sha }}
          files: release/*
          fail_on_unmatched_files: true

      - name: Create release
        if: ${{ needs.version-check.outputs.is_tag == 'true' }}
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          name: SAPL Language Server ${{ github.ref_name }}
          body: |
            ## SAPL Language Server ${{ github.ref_name }}

            Native executables for the SAPL Language Server.

            ### Downloads
            - `sapl-language-server-linux-amd64` - Linux x86_64 (static musl, works on any distro including NixOS)
            - `sapl-language-server-windows-amd64.exe` - Windows x86_64
            - `sapl-language-server-macos-arm64` - macOS Apple Silicon (ARM64)

            ### Verification
            Verify downloads using `SHA256SUMS.txt`:
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```

            ### Usage
            ```bash
            # Make executable (Linux/macOS)
            chmod +x sapl-language-server-*

            # Run in stdio mode (default for IDE integration)
            ./sapl-language-server-linux-amd64
            ```
          files: release/*
          fail_on_unmatched_files: true

  publish-docs:
    needs: [test, version-check]
    if: >-
      ${{
        !failure() && !cancelled() &&
        (
          (github.ref == 'refs/heads/master' && needs.version-check.outputs.is_snapshot == 'true')
          || needs.version-check.outputs.is_tag == 'true'
        )
      }}
    name: Publish Documentation
    uses: ./.github/workflows/build_documentation.yml
    secrets: inherit

  deploy-playground:
    needs: [publish-docker, version-check]
    if: >-
      ${{
        !failure() && !cancelled() &&
        (
          (github.ref == 'refs/heads/master' && needs.version-check.outputs.is_snapshot == 'true')
          || needs.version-check.outputs.is_tag == 'true'
        )
      }}
    name: Deploy Playground
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Deploy Playground to Server
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        with:
          host: ${{ secrets.PLAYGROUND_SERVER_HOST }}
          username: ${{ secrets.PLAYGROUND_SERVER_USERNAME }}
          key: ${{ secrets.PLAYGROUND_SERVER_SSH_KEY }}
          script: |
            docker pull ghcr.io/heutelbeck/sapl-playground:${{ needs.version-check.outputs.version }}
            docker stop sapl-playground || true
            docker rm sapl-playground || true
            docker run -d \
              --name sapl-playground \
              --restart unless-stopped \
              -p 9003:8080 \
              -e SAPL_PLAYGROUND_BASEURL=https://playground.sapl.io \
              ghcr.io/heutelbeck/sapl-playground:${{ needs.version-check.outputs.version }}

            echo "Verifying deployment..."
            sleep 10

            # Verify container is running
            if ! docker ps | grep -q sapl-playground; then
              echo "ERROR: Container not running"
              docker logs sapl-playground --tail 50
              exit 1
            fi
            echo "[OK] Container is running"

            # Verify users can access the playground
            echo "Checking public availability at https://playground.sapl.io ..."
            for i in {1..6}; do
              if curl -f -s -m 10 https://playground.sapl.io > /dev/null 2>&1; then
                echo "[OK] Playground is publicly accessible"
                exit 0
              fi
              echo "Attempt $i/6: Not ready yet, waiting 10s..."
              sleep 10
            done

            echo "ERROR: Playground not publicly accessible after 60 seconds"
            docker logs sapl-playground --tail 50
            exit 1

  trigger-downstream:
    needs: [publish-maven]
    if: ${{ github.ref == 'refs/heads/master' }}
    name: Trigger Downstream Builds
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Trigger CI Build of sapl-demos
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_on: error
          command: |
            curl -XPOST -u "${{ secrets.GHUB_USERNAME }}:${{ secrets.GHUB_ACCESS_TOKEN }}" -H "Accept: application/vnd.github.everest-preview+json" -H "Content-Type: application/json" https://api.github.com/repos/heutelbeck/sapl-demos/dispatches --data '{"event_type": "build_application"}'

      - name: Trigger CI Build of sapl-extensions
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3.0.2
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_on: error
          command: |
            curl -XPOST -u "${{ secrets.GHUB_USERNAME }}:${{ secrets.GHUB_ACCESS_TOKEN }}" -H "Accept: application/vnd.github.everest-preview+json" -H "Content-Type: application/json" https://api.github.com/repos/heutelbeck/sapl-extensions/dispatches --data '{"event_type": "build_application"}'
