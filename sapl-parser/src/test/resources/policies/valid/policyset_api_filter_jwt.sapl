/*
 * Policy set for controlling access to augmented manufacturing API
 * by means of json web tokens (JWT). Tokens are read securely from
 * subscription secrets via the JWT PIP.
 */
import filter.blacken

set "api_filter_jwt_set"
first or abstain errors propagate

//reject JWTs from unknown issuers
policy "api_filter_jwt:untrusted_issuer"
deny
	action.path.requestPath =~ "^/api.*";
	!(<jwt.token>.payload.iss in ["https://www.ftk.de/", "http://192.168.2.115:8080/", "http://localhost:8090"]);

// no role has access to nothing
policy "api_filter_jwt:nothing_allow_none"
deny
    action.path.requestPath =~ "^/api.*";
    <jwt.token>.payload.authorities == [];

// admin has access to everything
policy "api_filter_jwt:admin_allow_all"
permit
    action.path.requestPath =~ "^/api.*";
    "ROLE_ADMIN" in <jwt.token>.payload.authorities;
    <jwt.token>.valid;

// customers
policy "api_filter_jwt:client_deny_customer"
deny
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/customers.*";
    "ROLE_CLIENT" in <jwt.token>.payload.authorities;

policy "api_filter_jwt:nonclient_allow_customer"
permit
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/customers.*";
    !("ROLE_CLIENT" in <jwt.token>.payload.authorities);
    <jwt.token>.valid;

// orders
policy "api_filter_jwt:client_deny_order"
deny
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/orders.*";
    "ROLE_CLIENT" in <jwt.token>.payload.authorities;

policy "api_filter_jwt:nonclient_allow_order"
permit
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/orders.*";
    !("ROLE_CLIENT" in <jwt.token>.payload.authorities);
    <jwt.token>.valid;

// print jobs
policy "api_filter_jwt:engineer_operator_allow_all_printjob"
permit
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/printjobs.*";
    "ROLE_ENGINEER" in <jwt.token>.payload.authorities
     | "ROLE_OPERATOR" in <jwt.token>.payload.authorities;
    <jwt.token>.valid;

policy "api_filter_jwt:authenticated_allow_get_printjob"
permit
    action.path.requestPath =~ "^/api.*";
    "GET" == action.method;
    action.path.requestPath =~ "^/api/printjobs.*";
    "VALID" == <jwt.token>.validity;

// production plans
policy "api_filter_jwt:client_deny_original_or_annotated_3mf"
deny
    action.path.requestPath =~ "^/api.*";
    "GET" == action.method;
    action.path.requestPath =~ "^/api/production-plans/.*/threemf-file"
     | action.path.requestPath =~ "^/api/production-plans/.*/annotated-threemf-file";
    "ROLE_CLIENT" in <jwt.token>.payload.authorities;

policy "api_filter_jwt:client_blacken_printobject"
permit
    action.path.requestPath =~ "^/api.*";
    "GET" == action.method;
    action.path.requestPath =~ "^/api/production-plans/.*/print-objects";
    "ROLE_CLIENT" in <jwt.token>.payload.authorities;
    <jwt.token>.valid;
transform
    resource |- {@..customerName : blacken}

policy "api_filter_jwt:authenticated_allow_get_productionplan"
permit
    action.path.requestPath =~ "^/api.*";
    "GET" == action.method;
    action.path.requestPath =~ "^/api/production-plans.*";
    "VALID" == <jwt.token>.validity;

// files
policy "api_filter_jwt:client_deny_file"
deny
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/files.*";
    "ROLE_CLIENT" in <jwt.token>.payload.authorities;

policy "api_filter_jwt:engineer_allow_all_file"
permit
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/files.*";
    "ROLE_ENGINEER" in <jwt.token>.payload.authorities;
    <jwt.token>.valid;

policy "api_filter_jwt:authenticated_allow_get_file"
permit
    action.path.requestPath =~ "^/api.*";
    "GET" == action.method;
    action.path.requestPath =~ "^/api/files.*";
    "VALID" == <jwt.token>.validity;

// machines
policy "api_filter_jwt:engineer_operator_allow_all_machine"
permit
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/machines.*";
    "ROLE_ENGINEER" in <jwt.token>.payload.authorities
     | "ROLE_OPERATOR" in <jwt.token>.payload.authorities;
    <jwt.token>.valid;

policy "api_filter_jwt:authenticated_allow_get_machines"
permit
    action.path.requestPath =~ "^/api.*";
    "GET" == action.method;
    action.path.requestPath =~ "^/api/machines.*";
    "VALID" == <jwt.token>.validity;

// subscriptions
policy "api_filter_jwt:client_deny_subscription_anomaly"
deny
    action.path.requestPath =~ "^/api.*";
    action.path.requestPath =~ "^/api/subscriptions.*/anomaly";
    "ROLE_CLIENT" in <jwt.token>.payload.authorities;

policy "api_filter_jwt:authenticated_allow_get_subscription"
permit
    action.path.requestPath =~ "^/api.*";
    "GET" == action.method;
    action.path.requestPath =~ "^/api/subscriptions.*";
    "VALID" == <jwt.token>.validity;
